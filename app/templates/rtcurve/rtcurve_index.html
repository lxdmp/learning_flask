{% extends "base.html" %}

{% block page_content %}

<input type="button" id="auto_ref"/>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/socket.io.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/d3.v3.min.js') }}"></script>
<script>
$(document).ready(function() {
	
	// 初始化图表
	function init_chart()
	{
		var auto_ref = true;
		var svg_width = 900;
		var svg_height = 480;
		var margin = {
			"top" : 20, 
			"bottom" : 20, 
			"left" : 50, 
			"right" : 20
		};
		var buf_size = Math.round((svg_width-margin.left-margin.right)/10);
		var buf = new Array(buf_size);
		for(var i=0; i<buf.length; ++i)
		{
			buf[i] = {
				"data" : 0,
				"stamp" : null
			};
		}

		var svg = d3.select("body").append("svg")
			.attr("width", svg_width)
			.attr("height", svg_height);

		var x_scale, x_axis, y_scale, y_axis;

		function set_chart_parameters()
		{
			x_scale = d3.scale.linear()
				.domain([0, buf.length-1])
				.range([0, svg_width-margin.left-margin.right]);
			x_axis = d3.svg.axis()
				.scale(x_scale)
				.orient("bottom")
				.ticks(10)
				.tickFormat(function (i){
					if(buf[i].stamp==null)
						return "";
					return buf[i].stamp.split(" ")[1];
				});
			
			y_scale = d3.scale.linear()
				.domain(d3.extent(buf, function(d){
						return d.data;
					}))
				.range([svg_height-margin.bottom-margin.top, 0]);
			y_axis =d3.svg.axis()
				.scale(y_scale)
				.orient("left")
				.ticks(10);
		}

		set_chart_parameters();
		svg.append("g").attr("class", "x axis")
			.attr("transform","translate("+margin.left+","+(svg_height-margin.bottom)+")")
			.call(x_axis);
		svg.append("g").attr("class", "y axis")
			.attr("transform", "translate("+margin.left+","+margin.top+")")
			.call(y_axis);

		/*
		// for further debug
		var valid_index = function(buffer){
			return 0;
		};
		var valid_buffer = function(buffer){
			return buffer;
		};
		*/

		var valid_index = function(buffer){
			for(var i=0; i<buffer.length; ++i)
				if(buffer[i].stamp!=null)
					return i;
			return null;
		};

		var valid_buffer = function(buffer){
			var idx = valid_index(buffer);
			if(idx==null)
				return [];
			else
				return buffer.slice(idx, buffer.length);
		};

		var line = d3.svg.line()
			.x(function(d, i){
				return margin.left+x_scale(valid_index(buf)+i);
			})
			.y(function(d, i){
				return margin.top+y_scale(d.data);
			});
			//.interpolate('basis');

		// - 添加曲线
		svg.append("path")
			.attr("d", line(valid_buffer(buf)))
			.attr("class", "curve")
			.style("stroke-width", 2)
			.style("stroke", "#000")
			.style("fill", "none");

		// - 描点
		var radius_default = 3, radius_bold = 5;
		var point_x = function(d, i){
			return margin.left+x_scale(i);
		};
		var point_y = function(d, i){
			return margin.top+y_scale(d.data);
		};
		var point_visible = function(d, i){
			if(d.stamp==null)
				return "hidden";
			return "visible";
		};
		svg.selectAll("circle")
			.data(buf)
			.enter().append("circle")
			.attr("cx", function(d,i){
				return point_x(d, i);
			})
			.attr("cy", function(d, i){
				return point_y(d, i);
			})
			.attr("r", radius_default)
			.attr("class", "point")
			.style("fill", "#F00")
			.style("visibility", function(d, i){
				return point_visible(d, i);
			})
			.on("mouseover", function(){
				d3.select(this).transition().duration(100).attr("r", radius_bold);
			})
			.on("mouseout", function(){
				d3.select(this).transition().duration(100).attr("r", radius_default);
			});

		function redraw_chart(new_data) 
		{
			for(var i=0; i<buf.length-1; ++i)
				buf[i] = buf[i+1];
			buf[buf.length-1] = new_data;

			if(!auto_ref)
				return;

			set_chart_parameters();
			svg.selectAll("g.y.axis").call(y_axis);
			svg.selectAll("g.x.axis").call(x_axis);
			svg.selectAll(".curve")
				.attr("d", line(valid_buffer(buf)));
			
			svg.selectAll(".point")
				.data(buf)
				.attr("cx", function(d,i){
					return point_x(d, i);
				})
				.attr("cy", function(d, i){
					return point_y(d, i);
				})
				.style("visibility", function(d, i){
					return point_visible(d, i);
				});
		}

		return {
			"redraw" : redraw_chart, // 更新曲线
			"ref_flag" : function(){ // 前台是否刷新
				return auto_ref;
			},
			"toggle_ref" : function(){ // 前台刷新切换
				if(auto_ref)
					auto_ref = false;
				else
					auto_ref = true;
			}
		};
	}

	var handle = init_chart();
	var socket = io.connect("127.0.0.1:5000");
	socket.on("connect", function(){
		console.log("connected");
	});
	socket.on("disconnect", function(){
		console.log("disconnected");
	});
	socket.on('msg', function (data) {
		//console.log(data);
		handle.redraw(data);
	});

	d3.select("#auto_ref")
		.attr("value", "暂停")
		.on("click", function(){
			handle.toggle_ref();
			if(handle.ref_flag())
				d3.select(this).attr("value", "暂停");
			else
				d3.select(this).attr("value", "恢复");
		});
});
</script>
{% endblock %}

