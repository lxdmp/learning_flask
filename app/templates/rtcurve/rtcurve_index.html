{% extends "base.html" %}

{% block page_content %}

<p>测试</p>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/socket.io.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/d3.v3.min.js') }}"></script>
<script>
$(document).ready(function() {

	function init_chart()
	{
		var svg_width = 900;
		var svg_height = 480;
		var margin = {
			"top" : 20, 
			"bottom" : 20, 
			"left" : 50, 
			"right" : 20
		};
		var buf_size = Math.round((svg_width-margin.left-margin.right)/10);
		var buf = new Array(buf_size);
		var ind = new Array(buf.length);
		for(var i=0; i<buf.length; ++i)
		{
			buf[i] = 0;
			ind[i] = null;
		}

		var svg = d3.select("body").append("svg")
			.attr("width", svg_width)
			.attr("height", svg_height);

		var x_scale, x_axis, y_scale, y_axis;

		function set_chart_parameters()
		{
			x_scale = d3.scale.linear()
				.domain([0, buf.length-1])
				.range([0, svg_width-margin.left-margin.right]);
			x_axis = d3.svg.axis()
				.scale(x_scale)
				.orient("bottom")
				.ticks(10)
				.tickFormat(function (i){
					if(ind[i]==null)
						return "";
					return ind[i].split(" ")[1];
				});
			
			y_scale = d3.scale.linear()
				.domain([d3.min(buf), d3.max(buf)])
				.range([svg_height-margin.bottom-margin.top, 0]);
			y_axis =d3.svg.axis()
				.scale(y_scale)
				.orient("left")
				.ticks(20);
		}

		set_chart_parameters();
		svg.append("g").attr("class", "x axis")
			.attr("transform","translate("+margin.left+","+(svg_height-margin.bottom)+")")
			.call(x_axis);
		svg.append("g").attr("class", "y axis")
			.attr("transform", "translate("+margin.left+","+margin.top+")")
			.call(y_axis);

		var line = d3.svg.line()
			.x(function(d, i){
				return margin.left+x_scale(i);
			})
			.y(function(d, i){
				return margin.top+y_scale(d);
			})
			.interpolate('basis');

		svg.append("path")
			.attr("d", line(buf))
			.attr("class", "curve")
			.style("stroke-width", 2)
			.style("stroke", "#000")
			.style("fill", "none");

		var square_width = 5;
		var point_x = function(d, i){
			return margin.left+x_scale(i)-(square_width-1)/2;
		};
		var point_y = function(d, i){
			return margin.top+y_scale(d)-(square_width-1)/2;
		};
		var point_visible = function(d, i){
			if(ind[i]==null)
				return "hidden";
			return "visible";
		};
		svg.selectAll("rect")
			.data(buf)
			.enter().append("rect")
			.attr("x", function(d,i){
				return point_x(d, i);
			})
			.attr("y", function(d, i){
				return point_y(d, i);
			})
			.attr("width", square_width)
			.attr("height", square_width)
			.attr("class", "point")
			.style("fill", "#F00")
			.style("visibility", function(d, i){
				return point_visible(d, i);
			})

		function redraw_chart(new_data) 
		{
			for(var i=0; i<buf.length-1; ++i)
			{
				buf[i] = buf[i+1];
				ind[i] = ind[i+1];
			}
			buf[buf.length-1] = new_data.data;
			ind[ind.length-1] = new_data.stamp;

			set_chart_parameters();
			svg.selectAll("g.y.axis").call(y_axis);
			svg.selectAll("g.x.axis").call(x_axis);
			svg.selectAll(".curve")
				.attr("d", line(buf));
			
			svg.selectAll(".point")
				.data(buf)
				.attr("x", function(d,i){
					return point_x(d, i);
				})
				.attr("y", function(d, i){
					return point_y(d, i);
				})
				.style("visibility", function(d, i){
					return point_visible(d, i);
				});
		}

		return {"redraw" : redraw_chart};
	}

	var handle = init_chart();
	var socket = io.connect("127.0.0.1:5000");
	socket.on("connect", function(){
		console.log("connected");
	});
	socket.on("disconnect", function(){
		console.log("disconnected");
	});
	socket.on('msg', function (data) {
		handle.redraw(data);
	});


});
</script>
{% endblock %}

